flowchart TD
    subgraph BE["BACKEND (AdonisJS)"]
        CRON["Scheduling Engine<br/>(BullMQ)"] e3@--> CALC["PlayScheduleCalc<br/>PerScreen"]
        CALC e4@-->|"ScheduleCalculated"| PB["Ad Decisioning<br/>Engine"]
        PB e5@--> DB[("MySQL")]
        PB e6@-->|"ScreenScheduleBuilt"| PUSH["Pusher Push"]
        PH["PoP Endpoint<br/>+ Idempotency (Redis)"]
    end
    subgraph PL["MEDIA PLAYER (Tauri)"]
        INB["Inbox Handler<br/>dedup + version"] e7@--> FETCH["GET /v2/<br/>screen-schedule"]
        FETCH e8@--> CACHE["3-Tier Cache"]
        CACHE e9@--> SM["State Machine"]
        OUT["PoP Outbox"]
    end
    PUSH e1@-->|"WebSocket<br/>(typed)"| INB
    OUT e2@-->|"flush 1 min<br/>+ Idempotency Key"| PH
    e1@{ animation: slow }
    e2@{ animation: slow }
    e3@{ animation: fast }
    e4@{ animation: fast }
    e5@{ animation: slow }
    e6@{ animation: fast }
    e7@{ animation: fast }
    e8@{ animation: fast }
    e9@{ animation: fast }
    style BE fill:#f0f0f0,stroke:#666
    style PL fill:#f0f8ff,stroke:#004085
    style PB fill:#ffd700,stroke:#333
    style INB fill:#ffd700,stroke:#333
    style CACHE fill:#ffd700,stroke:#333
    style SM fill:#ffd700,stroke:#333
    style OUT fill:#ffd700,stroke:#333
    style PH fill:#cce5ff,stroke:#004085
