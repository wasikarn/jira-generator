%%{init: {"flowchart": {"subGraphTitleMargin": {"top": 0, "bottom": 45}}} }%%
flowchart TD
    subgraph INPUT["Input Data"]
        direction TB
        PS["playSchedules<br/>from PerScreen calc"]
        GS["guaranteedSchedules<br/>P1-G slots"]
        TK["takeoverSchedules<br/>P1-TK blocks"]
        ET["exactTimeSpots<br/>P1-ET spots"]
        MG["pendingMakeGoods<br/>compensation queue"]
        HP["housePlaylist<br/>owner filler content"]
    end

    subgraph ALGO["Ad Decisioning Algorithm v3"]
        direction TB
        S0["Step 0: Reserve Exact-Time<br/>P1-ET at play_at +/-5s"]
        S1["Step 1: Reserve Guaranteed<br/>P1-G at exact position"]
        S15["Step 1.5: Reserve Takeover<br/>P1-TK block boundaries"]
        S2["Step 2: Calculate SOV<br/>owner:platform ratio"]
        S25["Step 2.5: Campaign Pacing<br/>target - delivered = rate"]
        S3["Step 3: Fill Avails<br/>campaign + house interleave"]
        S4["Step 4: Fill Gaps<br/>remaining = house filler"]
        S5["Step 5: Flatten Timeline<br/>ordered sequence"]
        S55["Step 5.5: Insert Make-Good<br/>compensate interrupted ads"]
        S6["Step 6: Version + Persist<br/>ScreenSchedule v+1"]
    end

    subgraph OUTPUT["Output"]
        SS["ScreenSchedule v42<br/>ordered items array"]
        PL["Player: items 0, 1, 2..."]
    end

    INPUT e0@--> S0
    S0 e1@--> S1 e2@--> S15 e3@--> S2 e4@--> S25 e5@--> S3 e6@--> S4 e7@--> S5 e8@--> S55 e9@--> S6
    S6 e10@--> SS e11@--> PL

    e0@{ animation: slow }
    e1@{ animation: fast }
    e2@{ animation: fast }
    e3@{ animation: fast }
    e4@{ animation: fast }
    e5@{ animation: fast }
    e6@{ animation: fast }
    e7@{ animation: fast }
    e8@{ animation: fast }
    e9@{ animation: fast }
    e10@{ animation: fast }
    e11@{ animation: slow }

    style INPUT fill:#e8f4fd,stroke:#2196F3
    style ALGO fill:#fff8e1,stroke:#FFC107
    style OUTPUT fill:#e8f5e9,stroke:#4CAF50
