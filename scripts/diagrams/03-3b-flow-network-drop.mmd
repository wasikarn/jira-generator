sequenceDiagram
    participant BE as Backend
    participant PU as Pusher
    participant PL as Player
    Note over PL: ▶ Tier 1, version=42
    rect rgb(255, 200, 200)
        Note over BE,PL: ⚡ NETWORK DROPS
        BE->>BE: Cron → v43, v44, v45
        PU--xPL: (not delivered)
    end
    Note over PL: Tier 1 exhausted → Tier 2<br/>Tier 2 expired → Tier 3 (loop)
    rect rgb(200, 255, 200)
        Note over BE,PL: ✓ NETWORK RETURNS
        PU->>PL: Pusher reconnect
        Note over PL: Debounce 10s
    end
    PL->>BE: GET /device-playlist?since=42
    Note over BE: gap=3 → FULL playlist
    BE->>PL: {version:45, full:true}
    Note over PL: Replace Tier 1+2<br/>local_version=45<br/>→ ONLINE_PLAYBACK
    PL->>BE: POST /play-history (flush backlog)
    Note over BE: Dedup via idempotency keys
