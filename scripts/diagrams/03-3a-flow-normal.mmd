sequenceDiagram
    participant BE as Backend
    participant PU as Pusher
    participant PL as Player
    rect rgb(240, 240, 240)
        Note over BE: Cron → Calc → PlaylistBuilder
        BE->>BE: Save DevicePlaylist (v42)
        BE->>PU: playlist-updated
    end
    PU->>PL: {version:42, tier:live}
    Note over PL: Inbox: 42 > 41? ✓<br/>event_id new? ✓
    PL->>BE: GET /v2/device-playlist?since_version=41
    BE->>PL: {version:42, items, manifest}
    Note over PL: Save Tier 1 → download media<br/>local_version = 42
    rect rgb(200, 255, 200)
        Note over PL: ▶ Play sequence[0], [1], ...
    end
    PL->>BE: POST /v2/play-history<br/>X-Idempotency-Key: uuid
    BE->>PL: {ack_id: PH-xxx}
    Note over PL: Outbox: acked ✓
