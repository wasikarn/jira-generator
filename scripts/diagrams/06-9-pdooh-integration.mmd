flowchart TD
    subgraph ADE["Ad Decisioning Engine"]
        direction TB
        P1["P1: Reserve Guaranteed Spots<br/>(takeover, time-reserved)"]
        P2["P2: Fill Direct-Sold ROS<br/>+ Campaign Pacing"]
        P3{"P3: SSP<br/>configured?"}
        P3Y["Send Ad Request<br/>{screen_id, avail_duration,<br/>daypart, audience_est}"]
        P3N["Internal Spot Rotation<br/>(current frequency logic)"]
        P4["P4: Fill House/Filler Content"]
        SEQ["Flatten → Ordered Sequence<br/>version++ → persist"]
    end
    subgraph SSP["SSP / Programmatic (Future)"]
        RTB["RTB Auction<br/>(DSP bids)"]
        WIN["Winning Creative<br/>or 'no fill'"]
    end
    P1 e2@--> P2 e3@--> P3
    P3 e4@-->|"YES"| P3Y
    P3 e5@-->|"NO"| P3N
    P3Y e1@--> RTB e6@--> WIN
    e1@{ animation: slow }
    e2@{ animation: fast }
    e3@{ animation: fast }
    e4@{ animation: fast }
    e5@{ animation: fast }
    e6@{ animation: slow }
    e7@{ animation: fast }
    e8@{ animation: fast }
    e9@{ animation: fast }
    e10@{ animation: fast }
    WIN e7@-->|"creative"| P4
    WIN e8@-->|"no fill"| P3N
    P3N e9@--> P4 e10@--> SEQ
    style ADE fill:#f0f0f0,stroke:#666
    style SSP fill:#fff3cd,stroke:#ffc107
    style P1 fill:#ffd700,stroke:#333
    style P2 fill:#ffd700,stroke:#333
    style P3 fill:#fff3cd,stroke:#ffc107
    style P3Y fill:#cce5ff,stroke:#004085
    style P3N fill:#d4edda,stroke:#28a745
    style P4 fill:#e2e3e5,stroke:#6c757d
    style SEQ fill:#ffd700,stroke:#333
    style RTB fill:#fff3cd,stroke:#ffc107
    style WIN fill:#fff3cd,stroke:#ffc107
