flowchart TD
    subgraph BE["BACKEND (AdonisJS + BullMQ + Redis)"]
        Cron["Scheduling Engine<br/>(BullMQ) every 5m<br/>+ Event-driven"] e4@--> Calc["PlayScheduleCalculate<br/>NO CHANGE"]
        Calc e5@--> Per["PerScreen calc<br/>NO CHANGE"]
        Per e6@-->|"rows"| PB["⭐ Ad Decisioning<br/>Engine v3<br/>Pacing → SOV →<br/>Guaranteed → TK/ET →<br/>Make-Good → Sequence"]
        PB e7@--> DB[("MySQL<br/>NO CHANGE")]
        PB e8@--> DPL[("⭐ Screen Schedule<br/>+ TakeoverSchedule<br/>+ ExactTimeSpot<br/>+ MakeGoodRecord")]
        PB e9@--> Push["Pusher<br/>schedule-updated<br/>takeover-start/end<br/>p0-emergency"]
        TKB["⭐ TK Booking API<br/>overlap validation<br/>+ lead time check"]
    end
    Push e1@-->|"WebSocket"| INB
    subgraph PL["MEDIA PLAYER (Tauri Desktop App)"]
        INB["⭐ Inbox Handler<br/>dedup + version check"]
        INB e10@-->|"fetch"| CACHE["⭐ 3-Tier Cache<br/>LIVE / BUFFER / FALLBACK"]
        CACHE e11@--> SM["⭐ State Machine<br/>BOOT→SYNC→PLAY→OFFLINE"]
        SM e12@--> IC["⭐ Interrupt Controller<br/>P0/P1-TK/P1-ET: interrupt<br/>P1-G/P2-P4: wait"]
        IC e13@--> REN["Dumb Renderer<br/>play sequence[i++]"]
        OUT["⭐ PoP Outbox<br/>pending → sent → ack<br/>+ interrupted + make_good"]
    end
    subgraph APILAYER["API Endpoints"]
        API1["⭐ GET /v2/screen-schedule<br/>ordered spots + manifest"]
        API2["POST /v2/proof-of-play<br/>+ Idempotency Key<br/>+ interrupt fields"]
    end
    INB e2@-->|"GET"| API1
    OUT e3@-->|"flush 1 min"| API2
    e1@{ animation: slow }
    e2@{ animation: slow }
    e3@{ animation: slow }
    e4@{ animation: fast }
    e5@{ animation: fast }
    e6@{ animation: fast }
    e7@{ animation: slow }
    e8@{ animation: slow }
    e9@{ animation: fast }
    e10@{ animation: fast }
    e11@{ animation: fast }
    e12@{ animation: fast }
    e13@{ animation: fast }
    style BE fill:#f0f0f0,stroke:#666
    style PL fill:#f0f8ff,stroke:#004085
    style APILAYER fill:#f5f5f5,stroke:#999
    style PB fill:#ffd700,stroke:#333
    style DPL fill:#ffd700,stroke:#333
    style INB fill:#ffd700,stroke:#333
    style CACHE fill:#ffd700,stroke:#333
    style SM fill:#ffd700,stroke:#333
    style IC fill:#ff6b6b,stroke:#c92a2a
    style OUT fill:#ffd700,stroke:#333
    style API1 fill:#ffd700,stroke:#333
    style API2 fill:#cce5ff,stroke:#004085
    style TKB fill:#ff6b6b,stroke:#c92a2a
