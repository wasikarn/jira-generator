flowchart TD
    EV["Event occurs<br/>(ad played)"] e3@--> OB["Outbox Store<br/>(Tauri Store)"]
    OB e7@-.->|"Format"| FMT["id: uuid<br/>type, payload<br/>status: pending/sent/acked<br/>retry: 0, created_at"]
    OB e1@-->|"Flush ทุก 1 นาที"| API["POST /v2/play-history<br/>X-Idempotency-Key: uuid"]
    API e4@-->|"200 OK"| ACK["Mark acked<br/>Cleanup >24h"]
    API e5@-->|"timeout/error"| RETRY["Keep pending<br/>retry_count++"]
    RETRY e2@-->|"retry < 10"| OB
    RETRY e6@-->|"retry >= 10"| FAIL["Mark failed<br/>Log diagnostic"]
    e1@{ animation: slow }
    e2@{ animation: fast }
    e3@{ animation: fast }
    e4@{ animation: fast }
    e5@{ animation: fast }
    e6@{ animation: fast }
    e7@{ animation: fast }
    style EV fill:#cce5ff,stroke:#004085
    style OB fill:#fff3cd,stroke:#ffc107
    style API fill:#cce5ff,stroke:#004085
    style ACK fill:#d4edda,stroke:#28a745
    style RETRY fill:#fff3cd,stroke:#ffc107
    style FAIL fill:#f8d7da,stroke:#dc3545
