stateDiagram-v2
    direction TB

    [*] --> BOOT
    BOOT : Check localStorage

    BOOT --> CACHED_PLAYBACK : Has localStorage
    BOOT --> SPLASH : No localStorage
    SPLASH --> SYNCING_FIRST : Connected
    note right of SPLASH : No internet → retry every 5s

    CACHED_PLAYBACK : ▶ Play from cache
    CACHED_PLAYBACK --> SYNCING_DELTA : Online
    CACHED_PLAYBACK --> OFFLINE_PLAYBACK : Not online

    SYNCING_FIRST : Fetch full playlist
    SYNCING_DELTA : Fetch delta since last version
    SYNCING_FIRST --> ONLINE_PLAYBACK : Playlist fetched
    SYNCING_DELTA --> ONLINE_PLAYBACK : Delta applied

    state Playback {
        direction TB
        ONLINE_PLAYBACK --> OFFLINE_PLAYBACK : Network drop
        OFFLINE_PLAYBACK --> ONLINE_PLAYBACK : Reconnect
        OFFLINE_PLAYBACK --> FALLBACK : Tier 1+2 exhausted
        FALLBACK --> ONLINE_PLAYBACK : Reconnect
        FALLBACK --> SPLASH_LAST : Tier 3 empty

        ONLINE_PLAYBACK --> INTERRUPTED : P0/P1-TK/P1-ET trigger
        INTERRUPTED --> ONLINE_PLAYBACK : resume next item
        note right of INTERRUPTED : Transient state\nStop current → play interrupt → resume

        OFFLINE_PLAYBACK : ▶ Tier 1 → 2 → 3
        SPLASH_LAST : ▶ Logo + contact admin
    }

    SPLASH_LAST --> [*]

    classDef green fill:#d4edda,stroke:#28a745,stroke-width:2px
    classDef yellow fill:#fff3cd,stroke:#ffc107,stroke-width:2px
    classDef red fill:#f8d7da,stroke:#dc3545,stroke-width:2px
    classDef interrupt fill:#ff6b6b,stroke:#c92a2a,stroke-width:2px

    class ONLINE_PLAYBACK green
    class OFFLINE_PLAYBACK yellow
    class FALLBACK,SPLASH_LAST red
    class INTERRUPTED interrupt
