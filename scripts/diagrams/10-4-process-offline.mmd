flowchart TD
    E_DROP["NetworkDropped"]
    POL_OFFLINE{{"State Machine:<br/>ONLINE to OFFLINE"}}
    AGG_CACHE["3-Tier Cache"]
    RM_T1[/"Tier 1: LIVE<br/>current round"/]
    POL_T1{{"Play Tier 1<br/>until exhausted"}}
    E_T1_DONE["Tier1Exhausted"]
    RM_T2[/"Tier 2: BUFFER<br/>next 2-4 hours"/]
    POL_T2{{"Play Tier 2<br/>until expired"}}
    E_T2_DONE["Tier2Expired"]
    RM_T3[/"Tier 3: FALLBACK<br/>house content loop"/]
    POL_T3{{"Play Tier 3<br/>loop forever"}}
    E_FALLBACK["FallbackActive"]

    E_RETURN["NetworkReturned"]
    POL_DEBOUNCE{{"Debounce:<br/>wait 10s stable"}}
    C_SYNC["DeltaSync<br/>GET since_version=N"]
    EXT_API[("Backend<br/>API")]
    AGG_CACHE2["3-Tier Cache"]
    E_SYNCED["DeviceResynced"]
    POL_RESUME{{"State Machine:<br/>back to ONLINE"}}

    E_DROP e2@--> POL_OFFLINE
    POL_OFFLINE e3@--> AGG_CACHE
    AGG_CACHE e4@--> RM_T1
    RM_T1 e5@-.-> POL_T1
    POL_T1 e6@--> E_T1_DONE
    E_T1_DONE e7@--> RM_T2
    RM_T2 e8@-.-> POL_T2
    POL_T2 e9@--> E_T2_DONE
    E_T2_DONE e10@--> RM_T3
    RM_T3 e11@-.-> POL_T3
    POL_T3 e12@--> E_FALLBACK

    E_RETURN e13@--> POL_DEBOUNCE
    POL_DEBOUNCE e14@--> C_SYNC
    C_SYNC e1@--> EXT_API
    EXT_API e15@--> AGG_CACHE2
    AGG_CACHE2 e16@--> E_SYNCED
    E_SYNCED e17@--> POL_RESUME
    e1@{ animation: slow }
    e2@{ animation: fast }
    e3@{ animation: fast }
    e4@{ animation: fast }
    e5@{ animation: fast }
    e6@{ animation: fast }
    e7@{ animation: fast }
    e8@{ animation: fast }
    e9@{ animation: fast }
    e10@{ animation: fast }
    e11@{ animation: fast }
    e12@{ animation: fast }
    e13@{ animation: fast }
    e14@{ animation: fast }
    e15@{ animation: slow }
    e16@{ animation: fast }
    e17@{ animation: fast }

