flowchart TD
    E_DROP["NetworkDropped"]
    POL_OFFLINE{{"State Machine:<br/>ONLINE to OFFLINE"}}
    AGG_CACHE["3-Tier Cache"]
    RM_T1[/"Tier 1: LIVE<br/>current round"/]
    POL_T1{{"Play Tier 1<br/>until exhausted"}}
    E_T1_DONE["Tier1Exhausted"]
    RM_T2[/"Tier 2: BUFFER<br/>next 2-4 hours"/]
    POL_T2{{"Play Tier 2<br/>until expired"}}
    E_T2_DONE["Tier2Expired"]
    RM_T3[/"Tier 3: FALLBACK<br/>house content loop"/]
    POL_T3{{"Play Tier 3<br/>loop forever"}}
    E_FALLBACK["FallbackActive"]

    E_RETURN["NetworkReturned"]
    POL_DEBOUNCE{{"Debounce:<br/>wait 10s stable"}}
    C_SYNC["DeltaSync<br/>GET since_version=N"]
    EXT_API[("Backend<br/>API")]
    AGG_CACHE2["3-Tier Cache"]
    E_SYNCED["DeviceResynced"]
    POL_RESUME{{"State Machine:<br/>back to ONLINE"}}

    E_DROP --> POL_OFFLINE
    POL_OFFLINE --> AGG_CACHE
    AGG_CACHE --> RM_T1
    RM_T1 -.-> POL_T1
    POL_T1 --> E_T1_DONE
    E_T1_DONE --> RM_T2
    RM_T2 -.-> POL_T2
    POL_T2 --> E_T2_DONE
    E_T2_DONE --> RM_T3
    RM_T3 -.-> POL_T3
    POL_T3 --> E_FALLBACK

    E_RETURN --> POL_DEBOUNCE
    POL_DEBOUNCE --> C_SYNC
    C_SYNC e1@--> EXT_API
    EXT_API --> AGG_CACHE2
    e1@{ animation: slow }
    AGG_CACHE2 --> E_SYNCED
    E_SYNCED --> POL_RESUME

    %% Events - Orange
    style E_DROP fill:#FF8C00,stroke:#CC7000,color:#fff
    style E_T1_DONE fill:#FF8C00,stroke:#CC7000,color:#fff
    style E_T2_DONE fill:#FF8C00,stroke:#CC7000,color:#fff
    style E_FALLBACK fill:#FF8C00,stroke:#CC7000,color:#fff
    style E_RETURN fill:#FF8C00,stroke:#CC7000,color:#fff
    style E_SYNCED fill:#FF8C00,stroke:#CC7000,color:#fff

    %% Commands - Blue
    style C_SYNC fill:#4169E1,stroke:#2850B0,color:#fff

    %% Aggregates - Yellow
    style AGG_CACHE fill:#FFD700,stroke:#CCB000,color:#333
    style AGG_CACHE2 fill:#FFD700,stroke:#CCB000,color:#333

    %% Policies - Lilac
    style POL_OFFLINE fill:#C8A2C8,stroke:#9B7A9B,color:#333
    style POL_T1 fill:#C8A2C8,stroke:#9B7A9B,color:#333
    style POL_T2 fill:#C8A2C8,stroke:#9B7A9B,color:#333
    style POL_T3 fill:#C8A2C8,stroke:#9B7A9B,color:#333
    style POL_DEBOUNCE fill:#C8A2C8,stroke:#9B7A9B,color:#333
    style POL_RESUME fill:#C8A2C8,stroke:#9B7A9B,color:#333

    %% Read Models - Green
    style RM_T1 fill:#90EE90,stroke:#6BBE6B,color:#333
    style RM_T2 fill:#90EE90,stroke:#6BBE6B,color:#333
    style RM_T3 fill:#90EE90,stroke:#6BBE6B,color:#333

    %% External - Pink
    style EXT_API fill:#FFB6C1,stroke:#CC929A,color:#333
