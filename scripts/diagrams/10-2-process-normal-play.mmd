flowchart TD
    A_PLAYER(["Player<br/>Device"])
    E_RECEIVED["ScheduleReceived<br/>via Pusher"]
    POL_DEDUP{{"Inbox: Check<br/>event_id + version"}}
    C_FETCH["FetchSchedule<br/>GET /v2/screen-schedule"]
    EXT_API[("Backend<br/>API")]
    AGG_CACHE["3-Tier Cache"]
    E_CACHED["CacheUpdated"]
    RM_SCHEDULE[/"Current Schedule<br/>sequence 1..N"/]
    POL_PLAY{{"Play items<br/>in sequence order"}}
    E_PLAYED["CreativePlayed"]
    C_RECORD["RecordPoP"]
    AGG_OUTBOX["PoP Outbox<br/>Tauri Store"]
    E_POP["PoPRecorded"]
    POL_FLUSH{{"Flush every 1 min<br/>+ X-Idempotency-Key"}}
    C_FLUSH["FlushToBackend"]
    EXT_API2[("Backend<br/>API")]
    E_ACKED["PoPAcknowledged"]

    E_RECEIVED e3@--> POL_DEDUP
    POL_DEDUP e4@-->|"new"| C_FETCH
    POL_DEDUP e5@-->|"duplicate"| SKIP["SKIP"]
    C_FETCH e1@--> EXT_API
    EXT_API e6@--> AGG_CACHE
    AGG_CACHE e7@--> E_CACHED
    RM_SCHEDULE e8@-.-> POL_PLAY
    E_CACHED e9@--> POL_PLAY
    A_PLAYER e10@-.-> POL_PLAY
    POL_PLAY e11@--> E_PLAYED
    E_PLAYED e12@--> C_RECORD
    C_RECORD e13@--> AGG_OUTBOX
    AGG_OUTBOX e14@--> E_POP
    E_POP e15@--> POL_FLUSH
    POL_FLUSH e16@--> C_FLUSH
    C_FLUSH e2@--> EXT_API2
    EXT_API2 e17@--> E_ACKED

    e1@{ animation: slow }
    e2@{ animation: slow }
    e3@{ animation: fast }
    e4@{ animation: fast }
    e5@{ animation: fast }
    e6@{ animation: fast }
    e7@{ animation: fast }
    e8@{ animation: fast }
    e9@{ animation: fast }
    e10@{ animation: fast }
    e11@{ animation: fast }
    e12@{ animation: fast }
    e13@{ animation: fast }
    e14@{ animation: fast }
    e15@{ animation: fast }
    e16@{ animation: fast }
    e17@{ animation: slow }

    %% Skip
