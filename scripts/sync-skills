#!/bin/bash
# Sync jira-generator skills + agents to ~/.claude/
# Symlinks are created with platform prefixes: jira-, confluence-
# Usage: sync-skills [--dry-run] [--verbose] [--remove]

SRC_BASE="$HOME/Codes/Works/tathep/jira-generator/.claude"
DST_BASE="$HOME/.claude"

DRY_RUN=false
VERBOSE=false
REMOVE=false

for arg in "$@"; do
  case "$arg" in
    --dry-run|-n) DRY_RUN=true ;;
    --verbose|-v) VERBOSE=true ;;
    --remove|-r)  REMOVE=true ;;
    --help|-h)
      echo "Usage: sync-skills [--dry-run] [--verbose] [--remove]"
      echo "  --dry-run   Show what would change without making changes"
      echo "  --verbose   Show unchanged entries too"
      echo "  --remove    Remove all jira-generator symlinks (undo sync)"
      exit 0
      ;;
  esac
done

if [ ! -d "$SRC_BASE" ] && [ "$REMOVE" = false ]; then
  echo "Error: source not found: $SRC_BASE"
  exit 1
fi

$DRY_RUN && echo "[dry-run — no changes will be made]" && echo ""

# ─── prefix maps ───────────────────────────────────────────────────────────
# Returns prefix for a skill directory name
get_skill_prefix() {
  case "$1" in
    # Confluence skills
    create-doc|update-doc)
      echo "confluence" ;;
    # Infrastructure — no prefix (not slash commands / already named)
    atlassian-scripts|jira-cache-server|shared-references)
      echo "" ;;
    # Everything else is Jira
    *)
      echo "jira" ;;
  esac
}

# Returns prefix for an agent filename (without extension)
get_agent_prefix() {
  case "$1" in
    # General-purpose agents — no prefix
    code-explorer)
      echo "" ;;
    # Already prefixed
    jira-search|jira-*)
      echo "" ;;
    # Everything else is Jira workflow
    *)
      echo "jira" ;;
  esac
}

# ─── remove_all: remove all jira-generator symlinks from a directory ──────
remove_all() {
  local dst="$1"

  local removed=0

  for link in "$dst"/*; do
    link="${link%/}"
    [ -L "$link" ] || continue
    target=$(readlink "$link")
    [[ "$target" == *"jira-generator"* ]] || continue
    echo "  - $(basename "$link")"
    $DRY_RUN || rm "$link"
    removed=$((removed + 1))
  done

  echo "  → -$removed removed"
}

# ─── sync_dirs: symlink directories (skills) ──────────────────────────────
sync_dirs() {
  local src="$1" dst="$2"

  mkdir -p "$dst"

  local added=0 unchanged=0 removed=0

  # Remove broken symlinks pointing to jira-generator
  for link in "$dst"/*/; do
    link="${link%/}"
    [ -L "$link" ] || continue
    target=$(readlink "$link")
    [[ "$target" == *"jira-generator"* ]] || continue
    if [ ! -e "$link" ]; then
      echo "  - $(basename "$link") (broken, removed)"
      $DRY_RUN || rm "$link"
      removed=$((removed + 1))
    fi
  done

  # Create symlinks with platform prefix
  for dir in "$src"/*/; do
    [ -d "$dir" ] || continue
    local name
    name=$(basename "$dir")
    local prefix
    prefix=$(get_skill_prefix "$name")
    local symname="${prefix:+${prefix}-}${name}"
    local dest="$dst/$symname"

    if [ -L "$dest" ]; then
      existing=$(readlink "$dest")
      if [[ "$existing" == *"jira-generator"* ]]; then
        $VERBOSE && echo "  ✓ $symname"
        unchanged=$((unchanged + 1))
      else
        echo "  skip: $symname (owned by another source)"
      fi
    elif [ -e "$dest" ]; then
      echo "  skip: $symname (real directory, not a symlink)"
    else
      echo "  + $symname"
      $DRY_RUN || ln -s "$dir" "$dest"
      added=$((added + 1))
    fi
  done

  echo "  → +$added added, $unchanged unchanged, -$removed removed"
}

# ─── sync_files: symlink individual files (agents) ────────────────────────
sync_files() {
  local src="$1" dst="$2" ext="$3"

  if [ ! -d "$src" ]; then
    echo "  (source not found, skipping)"
    return
  fi

  mkdir -p "$dst"

  local added=0 unchanged=0 removed=0

  # Remove broken file symlinks pointing to jira-generator
  for link in "$dst"/*."$ext"; do
    [ -L "$link" ] 2>/dev/null || continue
    target=$(readlink "$link")
    [[ "$target" == *"jira-generator"* ]] || continue
    if [ ! -e "$link" ]; then
      echo "  - $(basename "$link") (broken, removed)"
      $DRY_RUN || rm "$link"
      removed=$((removed + 1))
    fi
  done

  # Create symlinks with platform prefix
  for file in "$src"/*."$ext"; do
    [ -f "$file" ] || continue
    local base
    base=$(basename "$file" ".$ext")
    local prefix
    prefix=$(get_agent_prefix "$base")
    local symname="${prefix:+${prefix}-}${base}.${ext}"
    local dest="$dst/$symname"

    if [ -L "$dest" ]; then
      existing=$(readlink "$dest")
      if [[ "$existing" == *"jira-generator"* ]]; then
        $VERBOSE && echo "  ✓ $symname"
        unchanged=$((unchanged + 1))
      else
        echo "  skip: $symname (owned by another source)"
      fi
    elif [ -e "$dest" ]; then
      echo "  skip: $symname (real file, not a symlink)"
    else
      echo "  + $symname"
      $DRY_RUN || ln -s "$file" "$dest"
      added=$((added + 1))
    fi
  done

  echo "  → +$added added, $unchanged unchanged, -$removed removed"
}

# ── Remove mode ────────────────────────────────────────────────────────────
if [ "$REMOVE" = true ]; then
  echo "Skills ← $DST_BASE/skills/"
  remove_all "$DST_BASE/skills"

  echo ""
  echo "Agents ← $DST_BASE/agents/"
  remove_all "$DST_BASE/agents"

  echo ""
  echo "Done. Run sync-skills to re-add."
  exit 0
fi

# ── Sync mode ──────────────────────────────────────────────────────────────
echo "Skills → $DST_BASE/skills/"
sync_dirs "$SRC_BASE/skills" "$DST_BASE/skills"

echo ""
echo "Agents → $DST_BASE/agents/"
sync_files "$SRC_BASE/agents" "$DST_BASE/agents" "md"

# ── Summary ────────────────────────────────────────────────────────────────
echo ""
skill_count=$(find "$DST_BASE/skills" -maxdepth 1 -type l 2>/dev/null \
  | while read -r l; do readlink "$l"; done \
  | grep -c "jira-generator" || true)
agent_count=$(find "$DST_BASE/agents" -maxdepth 1 -type l 2>/dev/null \
  | while read -r l; do readlink "$l"; done \
  | grep -c "jira-generator" || true)
echo "Total from jira-generator: $skill_count skills, $agent_count agents"
